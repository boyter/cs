<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>{{ .SearchTerm }} - cs search</title>
	<style>
		*, *::before, *::after { box-sizing: border-box; }
		body {
			font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
			background: #1e1e1e;
			color: #d4d4d4;
			margin: 0;
			padding: 20px;
			line-height: 1.5;
		}
		.container { max-width: 960px; margin: 0 auto; }
		h1 { font-size: 1.4em; margin: 0 0 16px 0; color: #e0e0e0; }
		a { color: #569cd6; text-decoration: none; }
		a:hover { text-decoration: underline; }
		form {
			display: flex;
			gap: 8px;
			align-items: center;
			flex-wrap: wrap;
			margin-bottom: 16px;
		}
		.search-row {
			display: flex;
			gap: 8px;
			width: 100%;
		}
		input[type="text"] {
			flex: 1;
			min-width: 200px;
			padding: 8px 12px;
			background: #3c3c3c;
			border: 1px solid #555;
			border-radius: 4px;
			color: #d4d4d4;
			font-size: 14px;
		}
		input[type="text"]:focus { outline: none; border-color: #569cd6; }
		input[type="submit"] {
			padding: 8px 16px;
			background: #264f78;
			border: 1px solid #3a7cc6;
			border-radius: 4px;
			color: #fff;
			cursor: pointer;
			font-size: 14px;
		}
		input[type="submit"]:hover { background: #365f8a; }
		select {
			padding: 8px;
			background: #3c3c3c;
			border: 1px solid #555;
			border-radius: 4px;
			color: #d4d4d4;
			font-size: 14px;
		}
		.stats { color: #808080; font-size: 13px; }
		.results-layout { display: flex; gap: 24px; }
		.results-main { flex: 4; min-width: 0; }
		.results-sidebar { flex: 1; min-width: 150px; }
		.result-item {
			padding: 12px 0;
			border-bottom: 1px solid #333;
		}
		.result-item h4 { margin: 0 0 4px 0; font-size: 14px; font-weight: normal; }
		.result-item h4 a { color: #569cd6; }
		.result-item pre {
			margin: 8px 0 4px 0;
			padding: 10px;
			background: #0d1117;
			border-radius: 4px;
			font-family: "Cascadia Code", "Fira Code", "JetBrains Mono", "Consolas", monospace;
			font-size: 13px;
			color: #c9d1d9;
			white-space: pre-wrap;
			word-wrap: break-word;
			overflow-x: auto;
		}
		.result-item strong {
			background: #6b4c00;
			color: #ffd700;
			padding: 1px 2px;
			border-radius: 2px;
		}
		.jump-link { font-size: 12px; color: #808080; }
		.jump-link a { color: #808080; }
		.jump-link a:hover { color: #569cd6; }
		.sidebar-heading {
			font-size: 13px;
			text-transform: uppercase;
			letter-spacing: 0.5px;
			color: #808080;
			margin: 0 0 8px 0;
			padding-bottom: 6px;
			border-bottom: 1px solid #333;
		}
		.facet-list { list-style: none; padding: 0; margin: 0; }
		.facet-list li {
			padding: 3px 0;
			font-size: 13px;
		}
		.facet-list a { color: #d4d4d4; }
		.facet-list a:hover { color: #569cd6; }
		.facet-count { color: #808080; font-size: 12px; }
		.pages { padding: 16px 0; }
		.pages a {
			display: inline-block;
			padding: 4px 10px;
			margin-right: 4px;
			background: #3c3c3c;
			border-radius: 4px;
			font-size: 13px;
		}
		.pages a:hover { background: #4c4c4c; }
	</style>
</head>
<body>
	<div class="container">
		<form id="search-form" method="get" action="/">
			<div class="search-row">
				<input id="search-input" type="text" name="q" value="{{ .SearchTerm }}" autofocus="autofocus" onfocus="this.select()" placeholder="Search..." />
				<input type="submit" value="Search" />
			</div>
			<select name="rk" onchange="this.form.submit()">
				<option value="simple" {{ if eq .Ranker "simple" }}selected{{ end }}>simple</option>
				<option value="tfidf" {{ if eq .Ranker "tfidf" }}selected{{ end }}>tfidf</option>
				<option value="bm25" {{ if eq .Ranker "bm25" }}selected{{ end }}>bm25</option>
				<option value="structural" {{ if eq .Ranker "structural" }}selected{{ end }}>structural</option>
			</select>
			<select name="cf" onchange="this.form.submit()">
				<option value="default" {{ if eq .CodeFilter "default" }}selected{{ end }}>all</option>
				<option value="only-code" {{ if eq .CodeFilter "only-code" }}selected{{ end }}>only-code</option>
				<option value="only-comments" {{ if eq .CodeFilter "only-comments" }}selected{{ end }}>only-comments</option>
				<option value="only-strings" {{ if eq .CodeFilter "only-strings" }}selected{{ end }}>only-strings</option>
				<option value="only-declarations" {{ if eq .CodeFilter "only-declarations" }}selected{{ end }}>only-declarations</option>
				<option value="only-usages" {{ if eq .CodeFilter "only-usages" }}selected{{ end }}>only-usages</option>
			</select>
			<select name="gv" onchange="this.form.submit()">
				<option value="off" {{ if eq .Gravity "off" }}selected{{ end }}>gravity: off</option>
				<option value="low" {{ if eq .Gravity "low" }}selected{{ end }}>gravity: low</option>
				<option value="default" {{ if eq .Gravity "default" }}selected{{ end }}>gravity: default</option>
				<option value="logic" {{ if eq .Gravity "logic" }}selected{{ end }}>gravity: logic</option>
				<option value="brain" {{ if eq .Gravity "brain" }}selected{{ end }}>gravity: brain</option>
			</select>
			<select name="ns" onchange="this.form.submit()">
				<option value="silence" {{ if eq .Noise "silence" }}selected{{ end }}>noise: silence</option>
				<option value="quiet" {{ if eq .Noise "quiet" }}selected{{ end }}>noise: quiet</option>
				<option value="default" {{ if eq .Noise "default" }}selected{{ end }}>noise: default</option>
				<option value="loud" {{ if eq .Noise "loud" }}selected{{ end }}>noise: loud</option>
				<option value="raw" {{ if eq .Noise "raw" }}selected{{ end }}>noise: raw</option>
			</select>
			<span id="search-stats" class="stats">[{{ .ResultsCount }} results from {{ .ProcessedFileCount }} files in {{ .RuntimeMilliseconds }} ms]</span>
		</form>

		<div id="results-container" class="results-layout">
			{{if .Results -}}
			<div class="results-main">
				{{- range .Results }}
				<div class="result-item">
					<h4><a href="/file/{{ .Location }}?sp={{ .StartPos }}&ep={{ .EndPos }}">{{ .Title }}</a>{{ if .Language }} <span style="color:#808080;font-size:12px">({{ .Language }})</span>{{ end }}</h4>
					{{ if .Lines }}<div class="stats">{{ .Language }} | Lines: {{ .Lines }} | Code: {{ .Code }} | Comment: {{ .Comment }} | Blank: {{ .Blank }} | Complexity: {{ .Complexity }}</div>{{ end }}
					{{ if .IsLineMode }}<pre>{{ range .LineResults }}{{ if .Gap }}
{{ end }}<span style="color:#808080;user-select:none">{{ printf "%4d " .LineNumber }}</span>{{ .Content }}
{{ end }}</pre>{{ else }}{{- range .Content }}
					<pre>{{ . }}</pre>
					{{- end }}{{ end }}
					<span class="jump-link">[<a href="/file/{{ .Location }}?sp={{ .StartPos }}&ep={{ .EndPos }}#{{ .StartPos }}">jump to match</a>]</span>
				</div>
				{{- end }}

				<div class="pages">
				{{- range .Pages }}
					<a href="/?q={{ .SearchTerm }}&ss={{ .SnippetSize }}&p={{ .Value }}&ext={{ .Ext }}&rk={{ .Ranker }}&cf={{ .CodeFilter }}&gv={{ .Gravity }}&ns={{ .Noise }}">{{ .Name }}</a>
				{{- end }}
				</div>
			</div>
			{{- end}}
			{{if .ExtensionFacet }}
			<div class="results-sidebar">
				<div class="sidebar-heading">Extensions</div>
				<ul class="facet-list">
				{{- range .ExtensionFacet }}
					<li><a href="/?q={{ .SearchTerm }}&ss={{ .SnippetSize }}&ext={{ .Title }}&rk={{ .Ranker }}&cf={{ .CodeFilter }}&gv={{ .Gravity }}&ns={{ .Noise }}">{{ .Title }}</a> <span class="facet-count">({{ .Count }})</span></li>
				{{- end }}
				</ul>
			</div>
			{{- end }}
		</div>
	</div>
<script>
(function() {
	var input = document.getElementById('search-input');
	var form = document.getElementById('search-form');
	var stats = document.getElementById('search-stats');
	var container = document.getElementById('results-container');
	var selects = form.querySelectorAll('select');
	var timer = null;
	var controller = null;

	function escapeHTML(s) {
		var d = document.createElement('div');
		d.appendChild(document.createTextNode(s));
		return d.innerHTML;
	}

	function getParams() {
		var rk = form.querySelector('select[name="rk"]').value;
		var cf = form.querySelector('select[name="cf"]').value;
		var gv = form.querySelector('select[name="gv"]').value;
		var ns = form.querySelector('select[name="ns"]').value;
		return 'rk=' + encodeURIComponent(rk) + '&cf=' + encodeURIComponent(cf) + '&gv=' + encodeURIComponent(gv) + '&ns=' + encodeURIComponent(ns);
	}

	function doSearch() {
		var q = input.value;
		var params = getParams();
		var url = '/?q=' + encodeURIComponent(q) + '&' + params + '&format=json';

		history.replaceState(null, '', '/?q=' + encodeURIComponent(q) + '&' + params);

		if (!q.trim()) {
			stats.textContent = '';
			container.innerHTML = '';
			return;
		}

		stats.textContent = '[searching...]';

		if (controller) controller.abort();
		controller = new AbortController();

		fetch(url, { signal: controller.signal }).then(function(r) { return r.json(); }).then(function(data) {
			stats.textContent = '[' + data.resultsCount + ' results from ' + data.processedFileCount + ' files in ' + data.runtimeMilliseconds + ' ms]';
			renderResults(data);
		}).catch(function(e) {
			if (e.name !== 'AbortError') stats.textContent = '[error]';
		});
	}

	function renderResults(data) {
		var html = '';
		if (data.results && data.results.length > 0) {
			html += '<div class="results-main">';
			for (var i = 0; i < data.results.length; i++) {
				var r = data.results[i];
				html += '<div class="result-item">';
				html += '<h4><a href="/file/' + escapeHTML(r.location) + '?sp=' + r.startPos + '&ep=' + r.endPos + '">' + escapeHTML(r.title) + '</a>';
				if (r.language) html += ' <span style="color:#808080;font-size:12px">(' + escapeHTML(r.language) + ')</span>';
				html += '</h4>';
				if (r.lines) html += '<div class="stats">' + escapeHTML(r.language) + ' | Lines: ' + r.lines + ' | Code: ' + r.code + ' | Comment: ' + r.comment + ' | Blank: ' + r.blank + ' | Complexity: ' + r.complexity + '</div>';
				if (r.isLineMode && r.lineResults) {
					html += '<pre>';
					var prevLN = 0;
					for (var j = 0; j < r.lineResults.length; j++) {
						var lr = r.lineResults[j];
						if (prevLN > 0 && lr.lineNumber > prevLN + 1) {
							html += '\n';
						}
						prevLN = lr.lineNumber;
						var num = ('    ' + lr.lineNumber).slice(-4) + ' ';
						html += '<span style="color:#808080;user-select:none">' + num + '</span>' + lr.content + '\n';
					}
					html += '</pre>';
				} else if (r.content) {
					for (var j = 0; j < r.content.length; j++) {
						html += '<pre>' + r.content[j] + '</pre>';
					}
				}
				html += '<span class="jump-link">[<a href="/file/' + escapeHTML(r.location) + '?sp=' + r.startPos + '&ep=' + r.endPos + '#' + r.startPos + '">jump to match</a>]</span>';
				html += '</div>';
			}
			html += '<div class="pages">';
			if (data.pages) {
				for (var i = 0; i < data.pages.length; i++) {
					var p = data.pages[i];
					html += '<a href="/?q=' + encodeURIComponent(p.searchTerm) + '&ss=' + p.snippetSize + '&p=' + p.value + '&ext=' + encodeURIComponent(p.ext || '') + '&rk=' + encodeURIComponent(p.ranker) + '&cf=' + encodeURIComponent(p.codeFilter) + '&gv=' + encodeURIComponent(p.gravity) + '&ns=' + encodeURIComponent(p.noise) + '">' + escapeHTML(p.name) + '</a>';
				}
			}
			html += '</div></div>';
		}
		if (data.extensionFacet && data.extensionFacet.length > 0) {
			html += '<div class="results-sidebar"><div class="sidebar-heading">Extensions</div><ul class="facet-list">';
			for (var i = 0; i < data.extensionFacet.length; i++) {
				var f = data.extensionFacet[i];
				html += '<li><a href="/?q=' + encodeURIComponent(f.searchTerm) + '&ss=' + f.snippetSize + '&ext=' + encodeURIComponent(f.title) + '&rk=' + encodeURIComponent(f.ranker) + '&cf=' + encodeURIComponent(f.codeFilter) + '&gv=' + encodeURIComponent(f.gravity) + '&ns=' + encodeURIComponent(f.noise) + '">' + escapeHTML(f.title) + '</a> <span class="facet-count">(' + f.count + ')</span></li>';
			}
			html += '</ul></div>';
		}
		container.innerHTML = html;
	}

	// Remove inline onchange handlers and use JS event listeners
	for (var i = 0; i < selects.length; i++) {
		selects[i].removeAttribute('onchange');
		selects[i].addEventListener('change', function() { doSearch(); });
	}

	input.addEventListener('input', function() {
		clearTimeout(timer);
		timer = setTimeout(doSearch, 200);
	});

	form.addEventListener('submit', function(e) {
		e.preventDefault();
		clearTimeout(timer);
		doSearch();
	});
})();
</script>
</body>
</html>